app = require("express")
path = require("path")
ZeusAssets = require("zeus-assets")
events = require("zeus-events")
swig = require("swig")
require("zeus-plugin")
Pages = require("zeus-admin-pages")
Breadcrumbs = require("zeus-admin-breadcrumbs")
Menu = require("zeus-admin-menu")
Router = app.Router()

HeaderAssets = new ZeusAssets()
FooterAssets = new ZeusAssets()
Breadcrumbs.add "Главная", "/admin"
Menu.addSection "Основное"
Menu.addLink "Основное", "Главная", "speedometer", "/admin/" 

#Assets
view_dir = "/static"
events.on "admin-header", (head)->
    head.registerStyles "main", view_dir + "/css/oneui.css"
    head.registerStyles "source-sans-pro", "http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400italic,600,700%7COpen+Sans:300,400,400italic,600,700"

events.on "admin-footer", (foot)->
    foot.registerScript "jquery", view_dir + "/js/core/jquery.min.js"
    foot.registerScript "boostrap", view_dir + "/js/core/bootstrap.min.js"
    foot.registerScript "slimscroll", view_dir + "/js/core/jquery.slimscroll.min.js"
    foot.registerScript "scrollock", view_dir + "/js/core/jquery.scrollLock.min.js"
    foot.registerScript "appear", view_dir + "/js/core/jquery.appear.min.js"
    foot.registerScript "countTo", view_dir + "/js/core/jquery.countTo.min.js"
    foot.registerScript "placholder", view_dir + "/js/core/jquery.placeholder.min.js"
    foot.registerScript "cookie", view_dir + "/js/core/js.cookie.min.js"
    foot.registerScript "app", view_dir + "/js/app.js"

#Events
events.emit "admin-header", HeaderAssets
events.emit "admin-footer", FooterAssets
events.emit "admin-breadcrumbs", Breadcrumbs
events.emit "admin-menu", Menu

#Routes
for page in Pages.getPages()
    Router.get page.route, (req, res)->   
        #Page render
        data = {}
        events.emit "prerender-#{page.name}-page", data        
        view = swig.renderFile(page.view, data)

        #Layout render
        layout = swig.renderFile(path.join(__dirname, "views", "layouts", "main.html"), {
            content: view
            title: page.title
            subtitle: page.subtitle
            breadcrumbs: Breadcrumbs.render()
            admin_menu: Menu.render()
            admin_header: HeaderAssets.render()
            admin_footer: FooterAssets.render()
        })
        res.end(layout)

module.exports = Router